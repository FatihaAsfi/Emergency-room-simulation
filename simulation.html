<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yale ER Simulation - Fixed</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#22c55e; --blue:#3b82f6; --red:#ef4444; --amber:#f59e0b;
    --ring:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(135deg,#0b1022,#0f172a 30%,#0b1022);
    color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;
    min-height:100vh; display:flex; justify-content:center; padding:20px;
  }
  .wrap{width:100%; max-width:1200px; display:grid; gap:16px; grid-template-columns: 1fr 1fr;}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.03),transparent 60%), var(--card);
    border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.35);
  }
  header.card{grid-column:1/-1; display:flex; align-items:center; justify-content:space-between;}
  h1{margin:0; font-size:24px}
  .subtitle{color:var(--muted); font-size:14px}

  .scenarios{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:16px}
  .scenario-btn{
    padding:12px; border-radius:12px; border:1px solid var(--ring);
    background:#0b1224; color:var(--text); cursor:pointer; transition:all .2s;
    text-align:center; position:relative;
  }
  .scenario-btn.active{border-color:var(--blue); background:rgba(59,130,246,.1)}
  .scenario-btn:hover{transform:translateY(-2px)}
  .scenario-title{font-weight:700; margin-bottom:4px; font-size:14px}
  .scenario-desc{font-size:11px; color:var(--muted); margin-bottom:6px}
  .scenario-kpi{font-size:10px; color:var(--muted)}

  .status-dot{
    position:absolute; top:8px; right:8px; width:10px; height:10px; border-radius:50%;
  }
  .status-critical{background:var(--red)}
  .status-stable{background:var(--accent)}

  .controls{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:12px 0}
  .control{display:flex; flex-direction:column; gap:4px}
  label{font-size:12px; color:var(--muted)}
  input, select{
    background:#0b1224; color:var(--text); padding:8px; border-radius:8px; 
    border:1px solid var(--ring); outline:none; font-size:14px;
  }
  .btn{
    padding:10px 14px; border-radius:10px; border:1px solid var(--ring);
    background:#0b1224; color:var(--text); cursor:pointer; font-weight:600;
    transition:all .2s; font-size:14px;
  }
  .btn:hover{transform:translateY(-1px)}
  .primary{background:var(--blue)}
  .danger{background:var(--red)}
  .success{background:var(--accent)}

  .btn-row{display:flex; gap:8px; margin-top:12px}
  .chip{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px;
        background:#0b1224; border:1px solid var(--ring); color:var(--muted); font-size:12px}

  .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin:16px 0}
  @media (max-width:768px){ .kpi{grid-template-columns:repeat(2,1fr)} }
  .kpi .tile{background:#0b1224; border:1px solid var(--ring); border-radius:10px; padding:12px; text-align:center}
  .kpi .label{font-size:11px; color:var(--muted); margin-bottom:4px}
  .kpi .val{font-size:18px; font-weight:800}

  .queue-section{max-height:300px; overflow-y:auto; margin:12px 0}
  .patient-card{
    display:flex; justify-content:space-between; align-items:center; gap:12px;
    background:#0b1224; border:1px solid var(--ring); border-radius:10px; 
    padding:8px 12px; margin-bottom:6px;
  }
  .sev{padding:3px 8px; border-radius:8px; font-size:11px; font-weight:700; color:white}
  .sev.critical{background:var(--red)}
  .sev.serious{background:var(--amber)}
  .sev.mild{background:var(--accent)}

  .doctor-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:8px; margin:12px 0}
  .doctor-card{
    background:#0b1224; border:1px solid var(--ring); border-radius:10px; padding:12px;
  }
  .progress-bar{height:6px; background:#374151; border-radius:3px; overflow:hidden; margin-top:6px}
  .progress-fill{height:100%; background:linear-gradient(90deg, var(--blue), #60a5fa); transition:width .5s}

  svg{width:100%; height:180px; display:block; background:#0b1224; border-radius:10px}
  .chart-container{margin:16px 0}
  .chart-title{font-size:14px; color:var(--muted); margin-bottom:8px}

  .alert{padding:12px; border-radius:10px; margin:8px 0; border-left:4px solid;}
  .alert.critical{background:rgba(239,68,68,.1); border-color:var(--red); color:#fca5a5}
  .alert.success{background:rgba(34,197,94,.1); border-color:var(--accent); color:#86efac}
  .alert.warning{background:rgba(245,158,11,.1); border-color:var(--amber); color:#fcd34d}

  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas}
  .text-center{text-align:center}
  .mt-2{margin-top:8px}
  .mb-2{margin-bottom:8px}
</style>
</head>
<body>
<div class="wrap">
  <header class="card">
    <div>
      <h1>ER Crisis Simulation</h1>
      <div class="subtitle">Emergency Department Capacity Analysis - Study Scenarios</div>
    </div>
    <div class="chip">Time: <span class="mono" id="simTime">0.0 min</span></div>
  </header>

  <div class="card">
    <h3 class="subtitle mb-2">Study Scenarios</h3>
    <div class="scenarios">
      <button class="scenario-btn active" data-scenario="crisis">
        <div class="status-dot status-critical"></div>
        <div class="scenario-title">Crisis</div>
        <div class="scenario-desc">Baseline conditions</div>
        <div class="scenario-kpi">3 docs, high load</div>
      </button>
      <button class="scenario-btn" data-scenario="staffing">
        <div class="status-dot status-stable"></div>
        <div class="scenario-title">+2 Doctors</div>
        <div class="scenario-desc">More capacity</div>
        <div class="scenario-kpi">5 docs, same load</div>
      </button>
      <button class="scenario-btn" data-scenario="process">
        <div class="status-dot status-stable"></div>
        <div class="scenario-title">Process Fix</div>
        <div class="scenario-desc">Efficiency gains</div>
        <div class="scenario-kpi">4 docs, faster</div>
      </button>
    </div>

    <div class="controls">
      <div class="control">
        <label>Doctors</label>
        <input id="doctors" type="number" min="1" max="8" value="3">
      </div>
      <div class="control">
        <label>Arrivals/Hour</label>
        <input id="arrivals" type="number" min="5" max="100" value="30">
      </div>
      <div class="control">
        <label>Simulation Speed</label>
        <select id="speed">
          <option value="1">Normal</option>
          <option value="5" selected>5x Fast</option>
          <option value="10">10x Fast</option>
        </select>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn primary" id="startBtn">Start Simulation</button>
      <button class="btn" id="stopBtn">Pause</button>
      <button class="btn danger" id="resetBtn">Reset</button>
      <button class="btn" id="addPatientBtn">Add Patient</button>
    </div>

    <div id="status" class="alert success">Ready to start simulation</div>
  </div>

  <div class="card">
    <h3 class="subtitle">Key Metrics</h3>
    <div class="kpi">
      <div class="tile">
        <div class="label">Arrivals</div>
        <div class="val" id="totalArrivals">0</div>
      </div>
      <div class="tile">
        <div class="label">Treated</div>
        <div class="val" id="totalTreated">0</div>
      </div>
      <div class="tile">
        <div class="label">In Queue</div>
        <div class="val" id="queueLength">0</div>
      </div>
      <div class="tile">
        <div class="label">Avg Wait (min)</div>
        <div class="val" id="avgWait">0</div>
      </div>
      <div class="tile">
        <div class="label">Traffic ρ</div>
        <div class="val" id="trafficIntensity">0.00</div>
      </div>
      <div class="tile">
        <div class="label">Utilization</div>
        <div class="val" id="utilization">0%</div>
      </div>
      <div class="tile">
        <div class="label">Max Wait (min)</div>
        <div class="val" id="maxWait">0</div>
      </div>
      <div class="tile">
        <div class="label">Throughput</div>
        <div class="val" id="throughput">0.0/hr</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 class="subtitle">Doctors Status</h3>
    <div id="doctorStatus" class="doctor-grid"></div>
  </div>

  <div class="card">
    <h3 class="subtitle">Priority Queue</h3>
    <div id="queueDisplay" class="queue-section">
      <div class="text-center" style="color:var(--muted); padding:20px">No patients waiting</div>
    </div>
  </div>

  <div class="card">
    <div class="chart-container">
      <div class="chart-title">Queue Length Over Time</div>
      <svg id="queueChart" viewBox="0 0 500 180"></svg>
    </div>
  </div>

  <div class="card">
    <div class="chart-container">
      <div class="chart-title">Patients by Severity</div>
      <svg id="severityChart" viewBox="0 0 500 180"></svg>
    </div>
  </div>
</div>

<script>
// Study scenarios with realistic parameters
const SCENARIOS = {
  crisis: { doctors: 3, arrivals: 30, criticalTime: 15, seriousTime: 8, mildTime: 4 },
  staffing: { doctors: 5, arrivals: 30, criticalTime: 15, seriousTime: 8, mildTime: 4 },
  process: { doctors: 4, arrivals: 30, criticalTime: 12, seriousTime: 6, mildTime: 3 }
};

// Simulation state
let sim = {
  running: false,
  time: 0,
  speed: 5,
  doctors: 3,
  arrivalsPerHour: 30,
  serviceTimes: { critical: 15, serious: 8, mild: 4 },
  
  queue: [],
  doctorList: [],
  stats: {
    arrivals: 0,
    treated: 0,
    waitTimes: [],
    maxWait: 0,
    treatedCount: { critical: 0, serious: 0, mild: 0 }
  },
  history: { queue: [], time: [] }
};

let patientId = 1;

// Patient generation with proper distribution
function createPatient() {
  const rand = Math.random();
  let severity;
  if (rand < 0.20) severity = 'critical';
  else if (rand < 0.55) severity = 'serious';
  else severity = 'mild';

  return {
    id: patientId++,
    name: `P${(patientId-1).toString().padStart(3,'0')}`,
    severity,
    arrivalTime: sim.time,
    waitTime: 0,
    serviceStartTime: null
  };
}

// Initialize doctors
function initializeDoctors() {
  sim.doctorList = [];
  for(let i = 0; i < sim.doctors; i++) {
    sim.doctorList.push({
      id: i + 1,
      busy: false,
      patient: null,
      timeRemaining: 0,
      totalBusyTime: 0
    });
  }
}

// Queue management with priority
function addToQueue(patient) {
  sim.queue.push(patient);
  sim.queue.sort((a, b) => {
    const priority = { critical: 1, serious: 2, mild: 3 };
    if (priority[a.severity] !== priority[b.severity]) {
      return priority[a.severity] - priority[b.severity];
    }
    return a.arrivalTime - b.arrivalTime;
  });
}

// Assign patients to available doctors
function processQueue() {
  for(let doctor of sim.doctorList) {
    if (!doctor.busy && sim.queue.length > 0) {
      const patient = sim.queue.shift();
      patient.serviceStartTime = sim.time;
      patient.waitTime = sim.time - patient.arrivalTime;
      
      sim.stats.waitTimes.push(patient.waitTime);
      if (patient.waitTime > sim.stats.maxWait) {
        sim.stats.maxWait = patient.waitTime;
      }
      
      doctor.busy = true;
      doctor.patient = patient;
      doctor.timeRemaining = exponentialRandom(sim.serviceTimes[patient.severity]);
    }
  }
}

// Exponential random number generator
function exponentialRandom(mean) {
  return -mean * Math.log(Math.random());
}

// Main simulation step
function simulateStep() {
  const deltaTime = 1; // 1 minute steps
  
  // Generate patient arrivals (Poisson process)
  const arrivalRate = sim.arrivalsPerHour / 60; // Convert to per minute
  if (Math.random() < arrivalRate * deltaTime) {
    const patient = createPatient();
    addToQueue(patient);
    sim.stats.arrivals++;
  }
  
  // Update doctor states
  for(let doctor of sim.doctorList) {
    if (doctor.busy) {
      doctor.timeRemaining -= deltaTime;
      doctor.totalBusyTime += deltaTime;
      
      if (doctor.timeRemaining <= 0) {
        // Patient treatment complete
        sim.stats.treated++;
        sim.stats.treatedCount[doctor.patient.severity]++;
        
        doctor.busy = false;
        doctor.patient = null;
        doctor.timeRemaining = 0;
      }
    }
  }
  
  // Assign waiting patients
  processQueue();
  
  // Update time
  sim.time += deltaTime;
  
  // Record history every 5 minutes
  if (sim.history.queue.length === 0 || sim.time - sim.history.time[sim.history.time.length-1] >= 5) {
    sim.history.queue.push(sim.queue.length);
    sim.history.time.push(sim.time);
    
    // Keep only recent history
    if (sim.history.queue.length > 50) {
      sim.history.queue.shift();
      sim.history.time.shift();
    }
  }
}

// Load scenario
function loadScenario(scenarioKey) {
  const scenario = SCENARIOS[scenarioKey];
  sim.doctors = scenario.doctors;
  sim.arrivalsPerHour = scenario.arrivals;
  sim.serviceTimes = {
    critical: scenario.criticalTime,
    serious: scenario.seriousTime,
    mild: scenario.mildTime
  };
  
  document.getElementById('doctors').value = sim.doctors;
  document.getElementById('arrivals').value = sim.arrivalsPerHour;
  
  // Update button states
  document.querySelectorAll('.scenario-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.scenario === scenarioKey);
  });
  
  resetSimulation();
  updateStatus(scenarioKey);
}

// Update status message
function updateStatus(scenario) {
  const statusEl = document.getElementById('status');
  const avgService = (0.2*sim.serviceTimes.critical + 0.35*sim.serviceTimes.serious + 0.45*sim.serviceTimes.mild);
  const capacity = sim.doctors * (60 / avgService);
  const rho = sim.arrivalsPerHour / capacity;
  
  if (rho >= 0.8) {
    statusEl.className = 'alert critical';
    statusEl.textContent = `${scenario.toUpperCase()}: System overloaded (ρ=${rho.toFixed(2)}). Queue will grow!`;
  } else if (rho >= 0.7) {
    statusEl.className = 'alert warning';
    statusEl.textContent = `${scenario.toUpperCase()}: System stressed (ρ=${rho.toFixed(2)}). Monitor closely.`;
  } else {
    statusEl.className = 'alert success';
    statusEl.textContent = `${scenario.toUpperCase()}: System stable (ρ=${rho.toFixed(2)}). Adequate capacity.`;
  }
}

// Reset simulation
function resetSimulation() {
  sim.running = false;
  sim.time = 0;
  sim.queue = [];
  sim.stats = {
    arrivals: 0,
    treated: 0, 
    waitTimes: [],
    maxWait: 0,
    treatedCount: { critical: 0, serious: 0, mild: 0 }
  };
  sim.history = { queue: [], time: [] };
  patientId = 1;
  
  initializeDoctors();
  updateDisplay();
  
  document.getElementById('startBtn').textContent = 'Start Simulation';
  document.getElementById('startBtn').className = 'btn primary';
}

// Update all displays
function updateDisplay() {
  // Update time
  document.getElementById('simTime').textContent = `${sim.time.toFixed(1)} min`;
  
  // Update metrics
  document.getElementById('totalArrivals').textContent = sim.stats.arrivals;
  document.getElementById('totalTreated').textContent = sim.stats.treated;
  document.getElementById('queueLength').textContent = sim.queue.length;
  
  const avgWait = sim.stats.waitTimes.length > 0 ? 
    sim.stats.waitTimes.reduce((a,b) => a+b, 0) / sim.stats.waitTimes.length : 0;
  document.getElementById('avgWait').textContent = Math.round(avgWait);
  document.getElementById('maxWait').textContent = Math.round(sim.stats.maxWait);
  
  // Traffic intensity
  const avgService = (0.2*sim.serviceTimes.critical + 0.35*sim.serviceTimes.serious + 0.45*sim.serviceTimes.mild);
  const capacity = sim.doctors * (60 / avgService);
  const rho = sim.arrivalsPerHour / capacity;
  const rhoEl = document.getElementById('trafficIntensity');
  rhoEl.textContent = rho.toFixed(2);
  rhoEl.style.color = rho >= 0.8 ? 'var(--red)' : rho >= 0.7 ? 'var(--amber)' : 'var(--accent)';
  
  // Utilization
  const totalBusyTime = sim.doctorList.reduce((sum, d) => sum + d.totalBusyTime, 0);
  const util = sim.time > 0 ? (totalBusyTime / (sim.time * sim.doctors)) * 100 : 0;
  document.getElementById('utilization').textContent = Math.round(util) + '%';
  
  // Throughput
  const throughput = sim.time > 0 ? (sim.stats.treated / sim.time) * 60 : 0;
  document.getElementById('throughput').textContent = throughput.toFixed(1) + '/hr';
  
  // Doctor status
  updateDoctorDisplay();
  
  // Queue display
  updateQueueDisplay();
  
  // Charts
  updateCharts();
}

function updateDoctorDisplay() {
  const container = document.getElementById('doctorStatus');
  container.innerHTML = '';
  
  sim.doctorList.forEach(doctor => {
    const div = document.createElement('div');
    div.className = 'doctor-card';
    
    if (doctor.busy && doctor.patient) {
      const serviceTime = sim.serviceTimes[doctor.patient.severity];
      const progress = Math.max(0, 100 - (doctor.timeRemaining / serviceTime) * 100);
      
      div.innerHTML = `
        <div><strong>Dr ${doctor.id}</strong></div>
        <div>Treating: ${doctor.patient.name}</div>
        <div><span class="sev ${doctor.patient.severity}">${doctor.patient.severity.toUpperCase()}</span></div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%"></div>
        </div>
        <div style="font-size:11px; color:var(--muted); margin-top:4px">
          ${Math.max(0, doctor.timeRemaining).toFixed(1)} min remaining
        </div>
      `;
    } else {
      div.innerHTML = `
        <div><strong>Dr ${doctor.id}</strong></div>
        <div style="color:var(--muted)">Available</div>
      `;
    }
    
    container.appendChild(div);
  });
}

function updateQueueDisplay() {
  const container = document.getElementById('queueDisplay');
  
  if (sim.queue.length === 0) {
    container.innerHTML = '<div class="text-center" style="color:var(--muted); padding:20px">No patients waiting</div>';
    return;
  }
  
  container.innerHTML = '';
  sim.queue.forEach((patient, index) => {
    const waitTime = sim.time - patient.arrivalTime;
    const div = document.createElement('div');
    div.className = 'patient-card';
    
    div.innerHTML = `
      <div>
        <strong>${patient.name}</strong>
        <div style="font-size:11px; color:var(--muted)">Waiting: ${Math.round(waitTime)} min</div>
      </div>
      <span class="sev ${patient.severity}">${patient.severity.toUpperCase()}</span>
    `;
    
    container.appendChild(div);
  });
}

function updateCharts() {
  // Queue chart
  const queueSvg = document.getElementById('queueChart');
  queueSvg.innerHTML = '';
  
  if (sim.history.queue.length > 1) {
    const maxQueue = Math.max(10, ...sim.history.queue);
    const width = 500, height = 180, pad = 40;
    
    // Draw line
    let pathData = '';
    sim.history.queue.forEach((q, i) => {
      const x = pad + (i / (sim.history.queue.length - 1)) * (width - 2*pad);
      const y = height - pad - (q / maxQueue) * (height - 2*pad);
      pathData += (i === 0 ? 'M' : 'L') + x + ',' + y;
    });
    
    queueSvg.innerHTML = `
      <path d="${pathData}" fill="none" stroke="#60a5fa" stroke-width="3"/>
      <line x1="${pad}" y1="${height-pad}" x2="${width-pad}" y2="${height-pad}" stroke="#6b7280" stroke-width="1"/>
      <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${height-pad}" stroke="#6b7280" stroke-width="1"/>
      <text x="${width/2}" y="${height-10}" fill="#9ca3af" font-size="12" text-anchor="middle">Time</text>
      <text x="15" y="${height/2}" fill="#9ca3af" font-size="12" text-anchor="middle" transform="rotate(-90 15 ${height/2})">Queue</text>
    `;
  }
  
  // Severity chart
  const severitySvg = document.getElementById('severityChart');
  const counts = [
    sim.stats.treatedCount.critical,
    sim.stats.treatedCount.serious, 
    sim.stats.treatedCount.mild
  ];
  const maxCount = Math.max(1, ...counts);
  const width = 500, height = 180, pad = 40;
  const barWidth = (width - 2*pad) / 4;
  
  severitySvg.innerHTML = `
    <line x1="${pad}" y1="${height-pad}" x2="${width-pad}" y2="${height-pad}" stroke="#6b7280" stroke-width="1"/>
    <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${height-pad}" stroke="#6b7280" stroke-width="1"/>
  `;
  
  const colors = ['#ef4444', '#f59e0b', '#22c55e'];
  const labels = ['Critical', 'Serious', 'Mild'];
  
  counts.forEach((count, i) => {
    const x = pad + (i + 0.5) * barWidth;
    const barHeight = (count / maxCount) * (height - 2*pad);
    const y = height - pad - barHeight;
    
    severitySvg.innerHTML += `
      <rect x="${x}" y="${y}" width="${barWidth*0.8}" height="${barHeight}" fill="${colors[i]}" rx="4"/>
      <text x="${x + barWidth*0.4}" y="${height-pad+15}" fill="#9ca3af" font-size="11" text-anchor="middle">${labels[i]}</text>
      <text x="${x + barWidth*0.4}" y="${y-5}" fill="#e5e7eb" font-size="12" text-anchor="middle">${count}</text>
    `;
  });
}

// Event handlers
document.addEventListener('DOMContentLoaded', () => {
  // Scenario buttons
  document.querySelectorAll('.scenario-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      loadScenario(btn.dataset.scenario);
    });
  });
  
  // Control buttons
  document.getElementById('startBtn').addEventListener('click', () => {
    if (sim.running) {
      sim.running = false;
      document.getElementById('startBtn').textContent = 'Start Simulation';
      document.getElementById('startBtn').className = 'btn primary';
    } else {
      sim.running = true;
      document.getElementById('startBtn').textContent = 'Running...';
      document.getElementById('startBtn').className = 'btn success';
    }
  });
  
  document.getElementById('stopBtn').addEventListener('click', () => {
    sim.running = false;
    document.getElementById('startBtn').textContent = 'Start Simulation';
    document.getElementById('startBtn').className = 'btn primary';
  });
  
  document.getElementById('resetBtn').addEventListener('click', resetSimulation);
  
  document.getElementById('addPatientBtn').addEventListener('click', () => {
    const patient = createPatient();
    addToQueue(patient);
    sim.stats.arrivals++;
    updateDisplay();
  });
  
  // Parameter changes
  document.getElementById('doctors').addEventListener('change', (e) => {
    sim.doctors = parseInt(e.target.value);
    resetSimulation();
  });
  
  document.getElementById('arrivals').addEventListener('change', (e) => {
    sim.arrivalsPerHour = parseInt(e.target.value);
  });
  
  document.getElementById('speed').addEventListener('change', (e) => {
    sim.speed = parseInt(e.target.value);
  });
  
  // Initialize
  loadScenario('crisis');
  
  // Main loop
  setInterval(() => {
    if (sim.running) {
      for(let i = 0; i < sim.speed; i++) {
        simulateStep();
      }
    }
    updateDisplay();
  }, 1000);
});
</script>
</body>
</html>
